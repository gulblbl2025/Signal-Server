version: 2.1

parameters:
  os:
    type: enum
    enum: [windows, ubuntu, macos]
    default: windows
  port:
    type: string
    default: "9001"

jobs:
  setup:
    parameters:
      os:
        type: enum
        enum: [windows, ubuntu, macos]
      port:
        type: string
    machine:
      image: << parameters.os >>
    environment:
      TZ: Asia/Shanghai
    steps:
      - checkout

      - run:
          name: 写入 frpc.toml
          shell: /bin/bash
          command: |
            cat << EOF > frpc.toml
            user = "VirtualMachine"
            serverAddr = "70.36.96.27"
            serverPort = 7000
            loginFailExit = true

            auth.method = "token"
            auth.token = "2f1d3a0e-9b64-4b91-b76b-8cb4a2f2e5d3"

            [[proxies]]
            name = "rdp<< parameters.port >>"
            type = "tcp"
            localIP = "<<#if parameters.os == 'windows'>>127.0.0.1<<else>>172.17.0.1<</if>>"
            localPort = 1234
            remotePort = << parameters.port >>
            EOF

            if [ "<< parameters.os >>" != "windows" ]; then
            cat << EOF >> frpc.toml
            [[proxies]]
            name = "ss"
            type = "tcp"
            localIP = "172.17.0.1"
            localPort = 8388
            remotePort = 8389
            EOF
            fi

      - when:
          condition:
            equal: [ "<< parameters.os >>", "windows" ]
          steps:
            - run:
                name: 运行 Windows
                shell: cmd.exe
                command: |
                  net user runneradmin mynewpassword@112233
                  tzutil /s "China Standard Time"
                  reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced" /v HideFileExt /t REG_DWORD /d 0 /f
                  reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced" /v Hidden /t REG_DWORD /d 1 /f
                  taskkill /f /im explorer.exe
                  start explorer.exe
                  netsh interface portproxy add v4tov4 listenport=1234 listenaddress=0.0.0.0 connectport=3389 connectaddress=127.0.0.1
                  frpc -c frpc.toml
                  timeout /t 86400

      - when:
          condition:
            equal: [ "<< parameters.os >>", "ubuntu" ]
          steps:
            - run:
                name: 运行 Linux
                command: |
                  sudo sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config || echo 'PasswordAuthentication yes' | sudo tee -a /etc/ssh/sshd_config
                  if [ -d /etc/ssh/sshd_config.d ]; then
                    sudo sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config.d/*.conf || echo 'PasswordAuthentication yes' | sudo tee -a /etc/ssh/sshd_config.d/*.conf
                  fi
                  sudo systemctl restart ssh
                  echo "runner:mynewpassword" | sudo chpasswd
                  docker run -d -p 1234:1234 --restart=always alpine/socat TCP-LISTEN:1234,fork TCP:172.17.0.1:22
                  docker run -d --name frpc -v ./frpc.toml:/etc/frp/frpc.toml snowdreamtech/frpc
                  docker run -d --restart unless-stopped -p 8388:8388/tcp -p 8388:8388/udp -e TZ=Asia/Shanghai -e METHOD=aes-256-gcm -e PASSWORD=6a17a5dd-5f76-4b09-b567-9b0d5d449da5 shadowsocks/shadowsocks-libev
                  docker logs -f frpc

      - when:
          condition:
            equal: [ "<< parameters.os >>", "macos" ]
          steps:
            - run:
                name: 运行 macOS
                command: |
                  echo "Running on macOS"
                  curl ipinfo.io
                  # 在此添加 macOS 特定的命令

workflows:
  version: 2
  frp:
    jobs:
      - setup:
          os: << pipeline.parameters.os >>
          port: << pipeline.parameters.port >>
